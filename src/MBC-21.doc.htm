<!DOCTYPE html>
<html>
<head>
    <title>[#MBC-21] whois смена логики работы</title>
    <meta http-equiv="Content-Type" Content="application/vnd.ms-word; charset=UTF-8">
        <style type="text/css">

.tableBorder, .grid
{
    background-color: #fff;
    width: 100%;
    border-collapse: collapse;
}

.tableBorder td, .grid td
{
    vertical-align: top;
    padding: 2px;
    border: 1px solid #ccc;
}

.noPadding
{
    padding: 0 !important;
}

h3 .subText
{
    font-size: 60%;
    font-weight: normal;
}

.tabLabel
{
    font-weight: bold;
    border: 1px solid #ccc;
    border-bottom:none;
    padding: 2px;
    display: inline;
}

td.blank
{
    padding: 0;
    margin: 0;
}

.blank td
{
    border: none;
}

#descriptionArea
{
    margin: 0;
    padding: 2px;
    border: 1px solid #ccc;
}

hr
{
    border-top:1px solid #aaa;
}

hr.fullcontent
{
  height: 15px;
  padding: 10px 0;
  background: #fff url('https://adagency.atlassian.net/images/icons/hr.gif') no-repeat scroll center;
}

</style>

</head>
<body>

<table class="tableBorder" cellpadding="0" cellspacing="0" border="0" width="100%">
    <tr>
        <td bgcolor="#f0f0f0" width="100%" colspan="2" valign="top">
                            <h3 class="formtitle">
                        [MBC-21]&nbsp;<a href="https://adagency.atlassian.net/browse/MBC-21">whois смена логики работы</a>
            <span class="subText">
               Created: 09/Jun/17                   &nbsp;Updated: 05/Jul/17

                                            </span>
            </h3>
        </td>
    </tr>
    <tr>
        <td width="20%"><b>Status:</b></td>
        <td width="80%">To Do</td>
    </tr>
    <tr>
        <td width="20%"><b>Project:</b></td>
        <td width="80%"><a href="https://adagency.atlassian.net/secure/BrowseProject.jspa?id=10100">MixTraff CRM</a></td>
    </tr>

        <tr>
            <td><b>Component/s:</b></td>
            <td>
                            None
                </td>
    </tr>
    

        <tr>
            <td><b>Affects Version/s:</b></td>
            <td>
                            None
                </td>
    </tr>
    

        <tr>
            <td><b>Fix Version/s:</b></td>
            <td>
                            None
                </td>
    </tr>
    
    </table>

<br />
<table class="grid" cellpadding="0" cellspacing="0" border="0" width="100%">
    <tr>
        <td bgcolor="#f0f0f0" valign="top" width="20%">
            <b>Type:</b>
        </td>
        <td bgcolor="#ffffff" valign="top"  width="30%" >
            Task
        </td>

                    <td bgcolor="#f0f0f0">
                <b>Priority:</b>
            </td>
            <td bgcolor="#ffffff" valign="top" nowrap>
                Medium
            </td>
            </tr>
    <tr>
                        <td bgcolor="#f0f0f0" valign="top" width="20%">
                <b>Reporter:</b>
            </td>
            <td bgcolor="#ffffff" valign="top"  width="30%" >
                                            <a class="user-hover" rel="vadik" id="word_reporter_vadik" href="https://adagency.atlassian.net/secure/ViewProfile.jspa?name=vadik">Vadim Klimenko</a>
                            </td>
        
                    <td bgcolor="#f0f0f0" width="20%">
                <b>Assignee:</b>
            </td>
            <td bgcolor="#ffffff" valign="top" nowrap  width="30%" >
                                            <a class="user-hover" rel="4841601" id="word_assignee_4841601" href="https://adagency.atlassian.net/secure/ViewProfile.jspa?name=4841601">yybitb</a>
                            </td>
            </tr>
    	<tr>
		<td bgcolor="#f0f0f0" width="20%">
			<b>Resolution:</b>
		</td>
		<td bgcolor="#ffffff" valign="top" width="30%" nowrap>
            				Unresolved
                    </td>
                    <td bgcolor="#f0f0f0" width="20%">
                <b>Votes:</b>
            </td>
            <td bgcolor="#ffffff" valign="top" width="30%" nowrap>
                0
            </td>
        
    </tr>
    
        <tr>
        <td bgcolor="#f0f0f0" width="20%">
            <b>Labels:</b>
        </td>
        <td id="labels-16401-value" class="value" bgcolor="#ffffff" valign="top" colspan="3" nowrap>
                            None
                    </td>
    </tr>
    
    	<tr>
        		<td bgcolor="#f0f0f0" width="20%"><b>Remaining Estimate:</b></td>
        <td bgcolor="#ffffff" valign="top" nowrap width="80%" colspan="3">
                            Not Specified
            		</td>
    </tr>
    <tr>
                <td bgcolor="#f0f0f0" width="20%"><b>Time Spent:</b></td>
		<td bgcolor="#ffffff" valign="top" nowrap width="80%" colspan="3">
                            Not Specified
            		</td>
	</tr>
    <tr>
                <td bgcolor="#f0f0f0" width="20%"><b>Original Estimate:</b></td>
		<td bgcolor="#ffffff" valign="top" nowrap width="80%" colspan="3">
                            Not Specified
            		</td>
    </tr>
    
    </table>



    <br />

    	<table class="grid" cellpadding="0" cellspacing="0" border="0" width="100%">
            

                <tr>
            <td bgcolor="#f0f0f0" width=20% valign=top>
                <b>Attachments:</b>
            </td>
            <td bgcolor="#ffffff" valign="top">
                                    <img src="https://adagency.atlassian.net/images/icons/attach/zip.gif" height="16" width="16" border="0" alt="Zip Archive">
                    domain-email_wi-backup.zip &nbsp;&nbsp;&nbsp;
                                    <img src="https://adagency.atlassian.net/images/icons/attach/zip.gif" height="16" width="16" border="0" alt="Zip Archive">
                    domain-email_wi-filter.zip &nbsp;&nbsp;&nbsp;
                                    <img src="https://adagency.atlassian.net/images/icons/attach/image.gif" height="16" width="16" border="0" alt="PNG File">
                    image-2017-06-09-11-30-01-703.png &nbsp;&nbsp;&nbsp;
                                    <img src="https://adagency.atlassian.net/images/icons/attach/image.gif" height="16" width="16" border="0" alt="PNG File">
                    image-2017-06-09-11-31-56-291.png &nbsp;&nbsp;&nbsp;
                            </td>
        </tr>
        
    



</table>

    <br/>

    <table cellpadding="2" cellspacing="0" border="0" width="100%" align="center">
    <tr>
        <td bgcolor="#bbbbbb" width="1%" nowrap align="center">
            &nbsp;<font color="#ffffff"><b>Description</b></font>&nbsp;
        </td>
        <td>&nbsp;</td>
    </tr>
    </table>

    <table cellpadding="0" cellspacing="0" border="0" width="100%">
    <tr>
        <td id="descriptionArea">
            <p>Нужно изменить логику парсинга who is данных:</p>

<p>1) отправлять запросы в who is сервисы с доменным именем www. нельзя<br/>
2.1) есть такие домены </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>www&amp;#8203;.vokrug.tv
</pre>
</div></div>
<p>Нужно чтобы вырезалось при сохранении домена www / пробелы и тд. в бд сервиса медиабаинга<br/>
2.2) домены кириллицы отправлять запрос нужно в виде </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>XN--J1AIL.XN--P1AI
</pre>
</div></div>
<p>к примеру,  домен кто.рф показывается в интерфейсе нашего сервисат так, а реквесты в сервис who is нужно отправлять в таком виде (чтобы исключить конфликты кодировок с сервисами) :</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>XN--J1AIL.XN--P1AI
</pre>
</div></div>

<p>3) все ссылки по содержанию поля 'url' на контактные формы , которые находим в JSON / XML при запросе к whois данным отправлять нужно в поле "Контакт WHOIS" добавить это поле нужно рядом с этим<br/>
<span class="image-wrap" style=""><a id="13801_thumb" href="https://adagency.atlassian.net/secure/attachment/13801/13801_image-2017-06-09-11-30-01-703.png" title="image-2017-06-09-11-30-01-703.png" file-preview-type="image" file-preview-id="13801" file-preview-title="image-2017-06-09-11-30-01-703.png"><jira-attachment-thumbnail url="https://adagency.atlassian.net/secure/thumbnail/13801/image-2017-06-09-11-30-01-703.png?default=false" jira-url="https://adagency.atlassian.net/secure/thumbnail/13801/image-2017-06-09-11-30-01-703.png" filename="image-2017-06-09-11-30-01-703.png"><img src="https://adagency.atlassian.net/secure/thumbnail/13801/image-2017-06-09-11-30-01-703.png" data-attachment-name="image-2017-06-09-11-30-01-703.png" data-attachment-type="thumbnail" data-media-services-id="302749ab-3898-4f44-b6dd-60f071839939" data-media-services-type="file" style="border: 0px solid black" /></jira-attachment-thumbnail></a></span></p>
<ul class="alternate" type="square">
	<li>к примеру<br/>
<span class="image-wrap" style=""><a id="13800_thumb" href="https://adagency.atlassian.net/secure/attachment/13800/13800_image-2017-06-09-11-31-56-291.png" title="image-2017-06-09-11-31-56-291.png" file-preview-type="image" file-preview-id="13800" file-preview-title="image-2017-06-09-11-31-56-291.png"><jira-attachment-thumbnail url="https://adagency.atlassian.net/secure/thumbnail/13800/image-2017-06-09-11-31-56-291.png?default=false" jira-url="https://adagency.atlassian.net/secure/thumbnail/13800/image-2017-06-09-11-31-56-291.png" filename="image-2017-06-09-11-31-56-291.png"><img src="https://adagency.atlassian.net/secure/thumbnail/13800/image-2017-06-09-11-31-56-291.png" data-attachment-name="image-2017-06-09-11-31-56-291.png" data-attachment-type="thumbnail" data-media-services-id="a1a67a5d-e81c-4e70-9926-ae829df0179d" data-media-services-type="file" style="border: 0px solid black" /></jira-attachment-thumbnail></a></span> </li>
</ul>
<ul>
	<li>для регистратора nic.ru нужно сохранять в поле <b>Контакт WHOIS</b> такую ссылку :<br/>
<a href="https://www.nic.ru/cgi/whois_webmail.cgi?domain=" class="external-link" rel="nofollow">https://www.nic.ru/cgi/whois_webmail.cgi?domain=</a>
{СЮДА_ПОДСТАВЛЯЕМ_ДОМЕН_ПЛОЩАДКИ}</li>
	<li>для регистратора r01.ru нужно сохранять в поле <b>Контакт WHOIS</b> такую ссылку: <a href="https://partner.r01.ru/contact_admin.khtml" class="external-link" rel="nofollow">https://partner.r01.ru/contact_admin.khtml</a></li>
	<li>для регистратора reg.ru нужно сохранять в поле <b>Контакт WHOIS</b> такую ссылку: <a href="http://www.reg.ru/whois/admin_contact" class="external-link" rel="nofollow">http://www.reg.ru/whois/admin_contact</a></li>
</ul>


<p>4) Все домены которые имеют в логах статус "Error" или не имеют данных по whois email или ссылки на форму связи должны опрашиваться до тех пор пока* :</p>
<ul>
	<li>Парсер не пройдется удачно по всем сервисам whois (см. их список ниже). То есть сервисы должны успешно открыться (ответ от сервиса должен быть 200 , не 403 , 503, 404 итд) и получен xml/json .</li>
	<li>Пока не будет подобрана удачная прокся, которая сможет зайти на сервис whois без капчи.</li>
	<li><font color="#d04437">Сервис bulk-whois-api.com опрашивается только один раз!</font> Только в случае если закончилась подписка нужно будет повторно отправить реквест для получения whois данных.</li>
</ul>


<p><font color="#d04437"><b>Принцип перебора сервисов whois:</b></font></p>

<p>1) Сначала мы парсим данные с bulk-whois-api.com , если не получили данные емейлы и ссылку для связи с админом домена, больше туда реквесты не отправляем. Если получили емейл или емейлы по домену, то считаем, что по домену уже все получено и по нему дальше перебор сервисов whois не продолжается. Если же нет, то приступаем к пункту 2 и тд. В случае если домен .RU или кириллица, то сначала опрашиваем пункты 3, 4, 5.<br/>
2) Потом идем в этот сервис используем прокси ( лимит 20 реквестов на 1 проксю ) </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>https://www.whoisxmlapi.com/hosted_pricing.php?domainName={DOMAIN.NAME}&amp;outputFormat=xml
</pre>
</div></div>
<p>3) Используем прокси максимум 20 реквестов на 1 проксю </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>http://r01.ru/domain/whois/check-domain.php?domain={DOMAIN.NAME}
</pre>
</div></div>
<p>4) Используем прокси максимум 20 реквестов на 1 проксю  </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>https://www.nic.ru/whois/?query={DOMAIN.NAME}
</pre>
</div></div>
<p>5) Используем прокси максимум 20 реквестов на 1 проксю  </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>https://www.reg.ru/whois/?dname={DOMAIN.NAME}
</pre>
</div></div>
<p>6) Используем прокси максимум 20 реквестов на 1 проксю </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre> 
https://whois.icann.org/en/lookup?name={DOMAIN.NAME}
</pre>
</div></div>
<p>7) Используем прокси максимум 20 реквестов на 1 проксю </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>http://www.whois-service.ru/
</pre>
</div></div>
<p>8) Используем прокси максимум 20 реквестов на 1 проксю </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>https://dig.whois.com.au/whois/{DOMAIN.NAME}
</pre>
</div></div>
<p>9) Используем прокси максимум 20 реквестов на 1 проксю </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>https://www.whois-search.com/whois/{DOMAIN.NAME}
</pre>
</div></div>
<p>10) Используем прокси максимум 20 реквестов на 1 проксю </p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>https://www.namecheap.com/domains/whois/results.aspx?domain={DOMAIN.NAME}
</pre>
</div></div>
            <br/>
        </td>
    </tr>
    </table>

    <br/>

    <table cellpadding="2" cellspacing="0" border="0" width="100%" align="center">
    <tr>
        <td bgcolor="#bbbbbb" width="1%" nowrap align="center">
            &nbsp;<font color="#ffffff"><b>Comments</b></font>&nbsp;
        </td>
        <td>&nbsp;</td>
    </tr>
    </table>

    <table cellpadding="0" cellspacing="0" border="0" width="100%" class="grid" style="margin: 0;">
                <tr id="comment-header-16514"><td bgcolor="#f0f0f0">
            Comment by  
                                                        <a class="user-hover" rel="4841601" id="word_commented_4841601" href="https://adagency.atlassian.net/secure/ViewProfile.jspa?name=4841601">yybitb</a>
                                        <font size="-2">
            [
                <font color="#336699">21/Jun/17</font>

                            ]
            </font>

        </td></tr>
        <tr id="comment-body-16514"><td bgcolor="#ffffff">
            <p>Комит 3efecdd4bc</p>

<p>1) <b>Добавил 8 доп. сервисов whois</b> к уже имеющемуся основному. Сервисы вызываются отдельным мастер-скриптом по крон расписанию 3 раза в час </p>

<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>/usr/local/bin/php /home/crmmixtraf/domains/yiic.php parseWhoisExtra queryAllDomains --verbose=1
</pre>
</div></div>

<p>2) сервис `<a href="https://whois.icann.org" class="external-link" rel="nofollow">https://whois.icann.org</a>` не добавлял тк. по 1му же запросу с 3 разных ИП требует ввода капчи.</p>
        </td></tr>
                <tr id="comment-header-16601"><td bgcolor="#f0f0f0">
            Comment by  
                                                        <a class="user-hover" rel="vadik" id="word_commented_vadik" href="https://adagency.atlassian.net/secure/ViewProfile.jspa?name=vadik">Vadim Klimenko</a>
                                        <font size="-2">
            [
                <font color="#336699">22/Jun/17</font>

                            ]
            </font>

        </td></tr>
        <tr id="comment-body-16601"><td bgcolor="#ffffff">
            <p>Пока тестируем.</p>
        </td></tr>
                <tr id="comment-header-16711"><td bgcolor="#f0f0f0">
            Comment by  
                                                        <a class="user-hover" rel="4841601" id="word_commented_4841601" href="https://adagency.atlassian.net/secure/ViewProfile.jspa?name=4841601">yybitb</a>
                                        <font size="-2">
            [
                <font color="#336699">26/Jun/17</font>

                            ]
            </font>

        </td></tr>
        <tr id="comment-body-16711"><td bgcolor="#ffffff">
            <p>Комит dc49eed4</p>

<ul>
	<li>Fix правила выборки. Ужесточение правил парсинга емайла регистранта - не выбирать емайл регистратора</li>
	<li>По существующим доменам (полям с емайлом whois) - 1) сделал бекап полей по состоянию "до изменений" (файл `domain-email_wi-backup.sql`) 2) вырезал все емайлы, не содержащие имя связанного домена и принадлежащие доменам, которые обрабатывались доп. сервисами whois (файл `domain-email_wi-filter.sql`).</li>
</ul>



<p>ref.</p>

<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>[23.06.2017 15:37:50] Vadim Klimenko [MixTraff]: 
там есть проблема парсяться почтовые регистраторов
то есть не самой площадки, а регистратора
и соответстенно если отпишутся по той почте
то в блек улетят все площадки
которые спарсились таким почтовым
-----------------------------------------------------------------------
[23.06.2017 15:42:53] Vadim Klimenko [MixTraff]: 
вообщем давай как временное решение
с привязкой к домену
</pre>
</div></div>
        </td></tr>
                <tr id="comment-header-17201"><td bgcolor="#f0f0f0">
            Comment by  
                                                        <a class="user-hover" rel="4841601" id="word_commented_4841601" href="https://adagency.atlassian.net/secure/ViewProfile.jspa?name=4841601">yybitb</a>
                                        <font size="-2">
            [
                <font color="#336699">05/Jul/17</font>

                            ]
            </font>

        </td></tr>
        <tr id="comment-body-17201"><td bgcolor="#ffffff">
            <p>Комит ebf9f462261 - удаление старых записей статистики для некоторых доп. сервисов whois</p>

<p><b>Проблема</b>: почти все сервисы набрали максимальное число возможных запросов (7000 запросов = 350 прокси * 20 запрос/прокси)</p>

<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>whoisxmlapicom	6650
ar01ru	7000
nicru	7000
regru	7000
whoisserviceru	7000
digwhoiscomau	7000
whoissearchcom	6874
namecheapcom	7000

</pre>
</div></div>

<p>Для всех кроме "whoisxmlapicom" произвожу <b>очистку статистики</b> по запросам старше 2х недель тк. блокировка (captcha или лимит запросов) обнаружена не была. </p>
        </td></tr>
            </table>
Generated at Thu Sep 14 07:19:21 UTC 2017 by yybitb using JIRA 1001.0.0-SNAPSHOT#100059-sha1:5bc2bce065aebd69bf5a23bc3efdd94fd09dddc8.

</body>
</html>